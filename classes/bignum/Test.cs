//Execute math library
exec("./basic.cs");
exec("./conditionals.cs");
exec("./nummanagement.cs");

$PrimeTable[-1 + %qqq++] = makeNum("801decb304156426e7fe99fad3c082cd5eebb093fdf06e2fb46a2f0e8d5e54e9");
$PrimeTable[-1 + %qqq++] = makeNum("84544abe17f698aea5c38612b004b215417f9f3b158fd94ec8b780d26015beb9");
$PrimeTable[-1 + %qqq++] = makeNum("85a6a50f398795e832ee957083c8234eda8ac1956e6bfce2a79af8197069e235");
$PrimeTable[-1 + %qqq++] = makeNum("86b31dc384d19b12156e6dad0019d58eee6e632aeb258449030451135e510dd3");
$PrimeTable[-1 + %qqq++] = makeNum("872e43abb527f6f84f6af24d8020360a073116b9ecaac438fd9757accafd255b");
$PrimeTable[-1 + %qqq++] = makeNum("8926a0e05fb0b71c1a654f249d3e7421ba185129d130fa3621c9a46492753429");
$PrimeTable[-1 + %qqq++] = makeNum("8db4a5455994ae58fe18920857bade8514d1c52d91ee6f70894a74bd1f5c4181");
$PrimeTable[-1 + %qqq++] = makeNum("91efd9130206cc1a2362f93b52f9240e3d51152759a9bfe86288ea203b140b79");
$PrimeTable[-1 + %qqq++] = makeNum("929199245a822757d980fe5801224db92cb016375ab6e351e481c56bf5b2c21d");
$PrimeTable[-1 + %qqq++] = makeNum("98fe6313e20b4abd241582a967470a9d782fc08e32769945a3061db449bac083");
$PrimeTable[-1 + %qqq++] = makeNum("9a7fce4449dde229a076166cc323a85b6c4fd70655b1c295a38c59215e5ed86b");
$PrimeTable[-1 + %qqq++] = makeNum("9a842d4519860776f02203ac08e44aef0b35688ed85f0c7a0b35b80e9d8d7cdf");
$PrimeTable[-1 + %qqq++] = makeNum("9b0ec8193a7df1a76da4c7aaf8811ad3a002abb222fcacffba948d191841b227");
$PrimeTable[-1 + %qqq++] = makeNum("a1cc8f70164434bbd2a3f851d4c9f3fa3ccb909a7952d61b8fcca4b32db940fd");
$PrimeTable[-1 + %qqq++] = makeNum("a35b54f128ab900f6c1730f1f368782391b95fc91bc8df1c9d05366b38b1a1a5");
$PrimeTable[-1 + %qqq++] = makeNum("a39b59955524311fa606227dcc3984dc0c01fa404a5f1c4f1045a50dd738b2c1");
$PrimeTable[-1 + %qqq++] = makeNum("a7d02e12ad98c77cec8fcae85ca5f4887280b1423a6bbe8c883215904868bb2d");
$PrimeTable[-1 + %qqq++] = makeNum("aa56ee28416bd686238cfa86e226ff25b05e9bdaff3c60861da2e1e78f5b2f39");
$PrimeTable[-1 + %qqq++] = makeNum("aafaaeef393f957559295c4f915bf63ad66aa219766619c83afbb5c2c7cc43cf");
$PrimeTable[-1 + %qqq++] = makeNum("abb3cc542b4294302ad71e5228c9b714a7a17156c5c993390f23c7dc025dd025");
$PrimeTable[-1 + %qqq++] = makeNum("acd939450d3d1a7a199846e52dff2cad32d61da53d30ebd11f26899456a7fd37");
$PrimeTable[-1 + %qqq++] = makeNum("ae0ace6908a4e71f03d79b1ecb5528c285e06215ff60af501afc26ee382342b3");
$PrimeTable[-1 + %qqq++] = makeNum("ae24ade19e4d21ec9f84b209a347ee455cff38105b716e94d63cd7c57a183385");
$PrimeTable[-1 + %qqq++] = makeNum("b296148d457190804cfb15d46539a6568ef3728f1bd02e9c7739c51b3a47c059");
$PrimeTable[-1 + %qqq++] = makeNum("b2f07916c121cd1f32e0aca93ce94ee9362ec3cac745cbedcb96016ffeae927f");
$PrimeTable[-1 + %qqq++] = makeNum("b37be3a0473cd100ef9841be44b624e51e6ea5cf89037999db3d3e0a9a7277c7");
$PrimeTable[-1 + %qqq++] = makeNum("b3fe1e0ebfde60270b77a6651edaaa06e70ea31aa3a37c2807b51872446c1b53");
$PrimeTable[-1 + %qqq++] = makeNum("b54089315125745431873bac42dc3e886b38d28e1f89eeebe1a54e9d4071e1f7");
$PrimeTable[-1 + %qqq++] = makeNum("b552a5a18421493f7989d8c0105924dd4d6e1c00f1fabd82facec878aef3cc77");
$PrimeTable[-1 + %qqq++] = makeNum("b5d400dae7e3595dd57c204ca788a03fd0e75e436f3d5598aa9293dedccd28d3");
$PrimeTable[-1 + %qqq++] = makeNum("bec7d218dc608a4eb2eeffb7fd22b65d5671b1dbaca097935a5f6883b5b93d63");
$PrimeTable[-1 + %qqq++] = makeNum("c21c2408a4f4b88ba84ff3cabc1bfe95e4f61c6e66f3baa9d7309183c6499bcd");
$PrimeTable[-1 + %qqq++] = makeNum("cb25ec3a9de4e933ac00e7f00251172a9c309143f0c9b4f6684eb02f2fddf969");
$PrimeTable[-1 + %qqq++] = makeNum("cd2cfa87d95a8576c8da9504f4da3cfa97da9ea4e86779acfa734824ba9efca3");
$PrimeTable[-1 + %qqq++] = makeNum("cfda500e531bb7b6bbeebaa693743ea10eae8208190c31ecfb3575f7e8347e15");
$PrimeTable[-1 + %qqq++] = makeNum("d07e7cf5a18af43c0b32fbcef795a1c91f0a8863e86c1378a2c195d3e956a0e1");
$PrimeTable[-1 + %qqq++] = makeNum("d29c23000e35287e33ca4d9de23f13bc6f258ee36a0591e42864ce47b4ab7361");
$PrimeTable[-1 + %qqq++] = makeNum("d2af3fa4358cf96b561bfb1b70b7f7d1e961554f67dc66f383272d235a5331c7");
$PrimeTable[-1 + %qqq++] = makeNum("d2ba119c38d73a8885ce697c96645377a88f55ad391fbdef1d0607adf8b5154d");
$PrimeTable[-1 + %qqq++] = makeNum("d345ed3c2cdef230ab068df31166c909e1b1a689fd139d28f8f13745056c72f9");
$PrimeTable[-1 + %qqq++] = makeNum("d3ec641886ec61e176c91b0ee4e2d62fcd1051ea67a1178cddeeee94d9feb425");
$PrimeTable[-1 + %qqq++] = makeNum("d4bebab6f0e382d26856d6d7361430c6fcf6c37c8a14f9360542260060fe139d");
$PrimeTable[-1 + %qqq++] = makeNum("d58a8c01116cff23fc230896c685adea9fc21291b9dd0513bbc62dc34d63de49");
$PrimeTable[-1 + %qqq++] = makeNum("d7176050994c739307f5645d1a198cba28201af0d21d6ccea6a8c81e09b765ed");
$PrimeTable[-1 + %qqq++] = makeNum("d75a754cbdc89a37f646d836ea3cd428c1b2cc5591e89148926d34d45f5b7c53");
$PrimeTable[-1 + %qqq++] = makeNum("d98ea6d95cff667b93cb301204780465ea7c0c536738e9481bac3ed62c298901");
$PrimeTable[-1 + %qqq++] = makeNum("daae333040d651cdaaca688b8dbff071b950e1b5cf0ff111ebbaac0a3794ee75");
$PrimeTable[-1 + %qqq++] = makeNum("dd7687b99631651a1b9a2210141b9cdad49748e9ec742cccf568d1968150c203");
$PrimeTable[-1 + %qqq++] = makeNum("e1a53cb0bba7e1a08258b436753a042766ac7491064a1f551430353db15fb709");
$PrimeTable[-1 + %qqq++] = makeNum("e320f14360e7c27d91fbf94074d3b3708806e272a501901b98eb377ce9fe874b");
$PrimeTable[-1 + %qqq++] = makeNum("e41031b6556ffd415b429ca60487ed1cce1e9229e084308b8e96948d5acbe65f");
$PrimeTable[-1 + %qqq++] = makeNum("e47d4fe0a64ec1787bc5095cd983b692f11c938b7dc5870ffd0d1a59763d61d5");
$PrimeTable[-1 + %qqq++] = makeNum("e500b77c0fef0a5aff51f1c9ca48ede63b58056608ca42b88aa04358234b61c1");
$PrimeTable[-1 + %qqq++] = makeNum("e76f4699bfc1917a6afcb6620a6b8b7bf8bbac9242baa939a4a16dbd7fb8fb57");
$PrimeTable[-1 + %qqq++] = makeNum("eaed33a088ec6cc1f5789feec5550c6600860a8cf3e004f34e7342fa2c7f123b");
$PrimeTable[-1 + %qqq++] = makeNum("f0388f66934fc68f1c99fbcf6cfc294f4681eb6625e86e994398239256b86cfb");
$PrimeTable[-1 + %qqq++] = makeNum("f1064b6ebdc6a5f64fb6395da85878c3680d5d39af96ef7a2d1c3396b3c208bd");
$PrimeTable[-1 + %qqq++] = makeNum("f6f9c76651aae5a3bac8125954fc7de79cecde08845b3514b3e243a952494fab");
$PrimeTable[-1 + %qqq++] = makeNum("f836b948d9afabf4cb38949ffa10b2470bad6972c827152f4219bb0ec1a98bbf");
$PrimeTable[-1 + %qqq++] = makeNum("f913000f9b51c8c9aa774c1f94c150136c930fdbd2df44bc2a34b55afc53ae6d");
$PrimeTable[-1 + %qqq++] = makeNum("fa29960d6b5533b2c680bbdf74b762f3704d7aa05df42a0f238949d44c654519");
$PrimeTable[-1 + %qqq++] = makeNum("fb8df2f9dbadf1ce4ec37ac2df1698b6033c23ab8cb2d36b3a4094c1ada0a3e1");
$PrimeTable[-1 + %qqq++] = makeNum("fcfc398a6634485237eca54448b31c85a657a5b7255d06a95c33e892c8bb1a79");
$PrimeTable[-1 + %qqq++] = makeNum("ffb686afab9c573ffa664fd49c03de04b05b5f2248556c6d57551c8a76a1f9ab");

function entropy(%string)
{
	echo("Bob sends Alice a request to chat.");
	echo("Alice asks bob for a prime modulus from a set of 64 to use.");
	echo("Bob chooses a random number between 0 and 63 and sends it to alice.");
	%PrimeIndex = getRandom(0,63);
	
	echo("Alice receives it, and retrieves the number from the table. Bob does the same.");
	$AlicePrime = $PrimeTable[%PrimeIndex];
	$BobPrime = $PrimeTable[%PrimeIndex];
	
	echo("Alice and Bob both pick random exponents by giving a random sample of text");
	echo("to a CSPRNG, which then creates the exponent.");
	AliceGetExponent("w4i5ynkhb 4ei5th8n");
	BobGetExponent("bghnrjgmben48trgiks");
	
	echo("Bob calculates 5^$BobExponent mod $BobPrime");
	$BobBase = makenum("0005");
	$BobFinal = makenum("0001");
	
	echo("Use exponentiation by squaring because FAST");
	for(%a = 0; %a < 16; %a++)
	{
		for(%b = 0; %b < 16; %b++)
		{
			if(($n[$BobExponent, %a] & (1 << %b)) != 0)
			{
				BigInt_Multiply($BobFinal, $BobBase);
				BigInt_Modulus($BobFinal, $BobPrime);
			}
			
			BigInt_Multiply($BobBase, $BobBase);
			BigInt_Modulus($BobBase, $BobPrime);
		}
	}
	$BobBase = makenum("0005");
	
	echo("Bob sends the number to Alice");
	$AliceShared = makenum(printnum($BobFinal));
	$BobFinal = makenum("0001");
	
	echo("Alice calculates 5^$AliceExponent mod $AlicePrime and sends it to Bob");
	$AliceBase = makenum("0005");
	$AliceFinal = makenum("0001");
	for(%a = 0; %a < 16; %a++)
	{
		for(%b = 0; %b < 16; %b++)
		{
			if(($n[$AliceExponent, %a] & (1 << %b)) != 0)
			{
				BigInt_Multiply($AliceFinal, $AliceBase);
				BigInt_Modulus($AliceFinal, $AlicePrime);
			}
			
			BigInt_Multiply($AliceBase, $AliceBase);
			BigInt_Modulus($AliceBase, $AlicePrime);
		}
	}
	$AliceBase = makenum("0005");
	$BobShared = makenum(printnum($AliceFinal));
	$AliceFinal = makenum("0001");
	
	echo("Alice calculates $AliceShared^$AliceExponent mod $AlicePrime");
	for(%a = 0; %a < 16; %a++)
	{
		for(%b = 0; %b < 16; %b++)
		{
			if(($n[$AliceExponent, %a] & (1 << %b)) != 0)
			{
				BigInt_Multiply($AliceFinal, $AliceShared);
				BigInt_Modulus($AliceFinal, $AlicePrime);
			}
			
			BigInt_Multiply($AliceShared, $AliceShared);
			BigInt_Modulus($AliceShared, $AlicePrime);
		}
	}
	
	echo("Bob calculates $BobShared^$BobExponent mod $BobPrime");
	for(%a = 0; %a < 16; %a++)
	{
		for(%b = 0; %b < 16; %b++)
		{
			if(($n[$BobExponent, %a] & (1 << %b)) != 0)
			{
				BigInt_Multiply($BobFinal, $BobShared);
				BigInt_Modulus($BobFinal, $BobPrime);
			}
			
			BigInt_Multiply($BobShared, $BobShared);
			BigInt_Modulus($BobShared, $BobPrime);
		}
	}
	$BobBase = makenum("0005");
	
	echo(printnum($AliceFinal) NL printnum($BobFinal));
}

function AliceGetExponent(%string)
{
	//Split gibberish into 2 parts
	%splitn = strlen(%string)>>1;
	%s1 = getsubstr(%string, 0, %splitn);
	%s2 = getsubstr(%string, %splitn, %splitn);
	
	//Hash parts a random number of times
	%max = getrandom(32, 2048);
	for(%a = 0; %a < %max; %a++)
	{
		//Each part affects the other
		%s1 = sha1(%s1 @ sha1(%s2));
		%s2 = sha1(%s2 @ sha1(%s1));
	}
	
	$AliceExponent = makenum(getsubstr(%s1 @ %s2, 7, 64));
}

function BobGetExponent(%string)
{
	//Split gibberish into 2 parts
	%splitn = strlen(%string)>>1;
	%s1 = getsubstr(%string, 0, %splitn);
	%s2 = getsubstr(%string, %splitn, %splitn);
	
	//Hash parts a random number of times
	%max = getrandom(32, 2048);
	for(%a = 0; %a < %max; %a++)
	{
		//Each part affects the other
		%s1 = sha1(%s1 @ sha1(%s2));
		%s2 = sha1(%s2 @ sha1(%s1));
	}
	
	$BobExponent = makenum(getsubstr(%s1 @ %s2, 7, 64));
}